/*
 *  Project: PicEdit
 *  Description: Creates an image upload box with tools to edit images on the front-end before uploading
 *  Author: 
 *  License: 
 */
!function(i,t,e,a){function s(t,e){this.inputelement=t,this.element=t,this.options=i.extend({},o,e),this._defaults=o,this._name=n,this._image=!1,this._variables={},this._template()}var n="picEdit",o={propertyName:"value",maxWidth:400,maxHeight:"auto",aspectRatio:!0};s.prototype={init:function(){var a=this;this._fileinput=i('<input type="file" accept="image/*">'),this._canvas=i(this.element).find("canvas")[0],this._ctx=this._canvas.getContext("2d"),this._videobox=i(this.element).find(".picedit_video")[0],this._painter=i(this.element).find(".picedit_painter")[0],this._messagebox=i(this.element).find(".picedit_message")[0],this._messagetimeout=!1,this._viewport={width:0,height:0},this._cropping={is_dragging:!1,is_resizing:!1,left:0,top:0,width:0,height:0,cropbox:i(this.element).find(".picedit_drag_resize")[0],cropframe:i(this.element).find(".picedit_drag_resize_box")[0]},i(this._fileinput).on("change",function(){var i=this.files[0],t=e.createElement("img");t.file=i;var s=new FileReader;s.onload=function(i){return function(t){i.src=t.target.result}}(t),s.readAsDataURL(i),t.onload=function(){a._image=t,a._resizeViewport(),a._paintCanvas(),a._updateInput()}}),i(e).on("paste",function(i){for(var t,s=(i.clipboardData||i.originalEvent.clipboardData).items,n=0;n<s.length;n++)0===s[n].type.indexOf("image")&&(t=s[n].getAsFile());if(t){var o=e.createElement("img"),c=new FileReader;c.onload=function(i){return function(t){i.src=t.target.result}}(o),c.readAsDataURL(t),o.onload=function(){a._image=o,a._resizeViewport(),a._paintCanvas(),a._updateInput()}}}),this._theformdata=!1,t.FormData?this._theformdata=new FormData(i(this.inputelement).parents("form")[0]):this.set_messagebox("Sorry, the FormData API is not supported!"),this._bindControlButtons(),this._bindInputVariables(),this._bindSelectionDrag(),this._variables.pen_color="black",this._variables.pen_size=!1,this._variables.prev_pos=!1},hide_messagebox:function(){i(this._messagebox).removeClass("active no_close_button").children("div").html("")},set_loading:function(i){return i&&1==i?this.set_messagebox("Working...",!1,!1):this.set_messagebox("Loading...",!1,!1)},set_messagebox:function(t,e,a){e="undefined"!=typeof e?e:2e3,a="undefined"!=typeof a?a:!0;var s="active";if(a||(s+=" no_close_button"),e){clearTimeout(this._messagetimeout);var n=this;this._messagetimeout=setTimeout(function(){n.hide_messagebox()},e)}return i(this._messagebox).addClass(s).children("div").html(t)},toggle_button:function(t){i(t).hasClass("active")?(value=!1,i(t).removeClass("active")):(value=!0,i(t).siblings().removeClass("active"),i(t).addClass("active"));var e=i(t).data("variable");if(e){var a=i(t).data("value");a||(a=i(t).val()),a&&value&&(value=a),this._setVariable(e,value)}this._variables.pen_color&&this._variables.pen_size?this.pen_tool_open():this.pen_tool_close()},load_image:function(){this._fileinput.click()},pen_tool_open:function(){this._ctx.lineJoin="round",this._ctx.lineCap="round",this._ctx.strokeStyle=this._variables.pen_color,this._ctx.lineWidth=this._variables.pen_size,i(this._painter).addClass("active"),this._hideAllNav()},pen_tool_close:function(){i(this._painter).removeClass("active")},rotate_ccw:function(){if(!this._image)return this._hideAllNav(1);var i=this;this.set_loading(1).delay(10).promise().done(function(){i._doRotation(-90),i._resizeViewport(),i.hide_messagebox()}),this._hideAllNav()},rotate_cw:function(){if(!this._image)return this._hideAllNav(1);var i=this;this.set_loading(1).delay(10).promise().done(function(){i._doRotation(90),i._resizeViewport(),i.hide_messagebox()}),this._hideAllNav()},resize_image:function(){if(!this._image)return this._hideAllNav(1);var i=this;this.set_loading(1).delay(10).promise().done(function(){var t=e.createElement("canvas"),a=t.getContext("2d");t.width=i._variables.resize_width,t.height=i._variables.resize_height,a.drawImage(i._image,0,0,t.width,t.height),i._image.src=t.toDataURL("image/png"),i._resizeViewport(),i._paintCanvas(),i._updateInput(),i.hide_messagebox()}),this._hideAllNav()},camera_open:function(){var t,e=navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.getUserMedia;if(!e)return this.set_messagebox("Sorry, your browser doesn't support WebRTC!");var a=this;(t=e.bind(navigator))({audio:!1,video:!0},function(t){var e=i(a._videobox).find("video")[0];e.src=URL.createObjectURL(t),i(a._videobox).addClass("active")},function(){return a.set_messagebox("No video source detected! Please allow camera access!")})},camera_close:function(){i(this._videobox).removeClass("active")},take_photo:function(){var t=this,a=i(this._videobox).find("video")[0],s=e.createElement("canvas"),n=s.getContext("2d");s.width=a.clientWidth,s.height=a.clientHeight,n.drawImage(a,0,0,s.width,s.height);var o=e.createElement("img");o.src=s.toDataURL("image/png"),o.onload=function(){t._image=o,i(t._videobox).removeClass("active"),t._resizeViewport(),t._paintCanvas(),t._updateInput()}},crop_image:function(){var i=this._calculateCropWindow(),t=this;this.set_loading(1).delay(10).promise().done(function(){var a=e.createElement("canvas"),s=a.getContext("2d");a.width=i.width,a.height=i.height,s.drawImage(t._image,i.left,i.top,i.width,i.height,0,0,i.width,i.height),t._image.src=a.toDataURL("image/png"),t._resizeViewport(),t._paintCanvas(),t._updateInput(),t.hide_messagebox()}),this.crop_close()},crop_open:function(){return this._image?(i(this._cropping.cropbox).addClass("active"),void this._hideAllNav()):this._hideAllNav(1)},crop_close:function(){i(this._cropping.cropbox).removeClass("active")},_bindSelectionDrag:function(){var e=this,a=this._cropping.cropframe,s=i(this._cropping.cropbox).find(".picedit_drag_resize_box_corner_wrap")[0],n=this._painter;i(t).on("mousedown",function(t){e._cropping.x=t.clientX,e._cropping.y=t.clientY,e._cropping.w=a.clientWidth,e._cropping.h=a.clientHeight,i(a).on("mousemove",function(i){e._cropping.is_dragging=!0,e._cropping.is_resizing||e._selection_drag_movement(i)}),i(s).on("mousemove",function(i){i.stopPropagation(),e._cropping.is_resizing=!0,e._selection_resize_movement(i)}),i(n).on("mousemove",function(i){i.stopPropagation(),e._painter_movement(i)})}).on("mouseup",function(){!e._cropping.is_dragging,e._cropping.is_dragging=!1,e._cropping.is_resizing=!1,e._variables.prev_pos=!1,i(a).off("mousemove"),i(s).off("mousemove"),i(n).off("mousemove")})},_selection_resize_movement:function(i){var t=this._cropping.cropframe;t.style.width=this._cropping.w+i.clientX-this._cropping.x+"px",t.style.height=this._cropping.h+i.clientY-this._cropping.y+"px"},_selection_drag_movement:function(t){var e=this._cropping.cropframe;i(e).offset({top:t.pageY-parseInt(e.clientHeight/2,10),left:t.pageX-parseInt(e.clientWidth/2,10)})},_painter_movement:function(i){var t={};return t.x=i.offsetX,t.y=i.offsetY,this._variables.prev_pos?(this._ctx.beginPath(),this._ctx.moveTo(this._variables.prev_pos.x,this._variables.prev_pos.y),this._ctx.lineTo(t.x,t.y),this._ctx.stroke(),void(this._variables.prev_pos=t)):this._variables.prev_pos=t},_hideAllNav:function(t){t&&1==t&&this.set_messagebox("Open an image or use your camera to make a photo!"),i(this.element).find(".picedit_nav_box").removeClass("active").find(".picedit_element").removeClass("active")},_paintCanvas:function(){this._canvas.width=this._viewport.width,this._canvas.height=this._viewport.height,this._ctx.drawImage(this._image,0,0,this._viewport.width,this._viewport.height),i(this.element).find(".picedit_canvas").css("display","block")},_calculateCropWindow:function(){var i=this._viewport,t={width:this._image.width,height:this._image.height},e={width:this._cropping.cropframe.clientWidth,height:this._cropping.cropframe.clientHeight,top:this._cropping.cropframe.offsetTop>0?this._cropping.cropframe.offsetTop:.1,left:this._cropping.cropframe.offsetLeft>0?this._cropping.cropframe.offsetLeft:.1};e.width+e.left>i.width&&(e.width=i.width-e.left),e.height+e.top>i.height&&(e.height=i.height-e.top);var a=e.width/i.width,s=e.height/i.height,n={width:parseInt(t.width*a,10),height:parseInt(t.height*s,10)},o=e.top/i.height,c=e.left/i.width;return n.top=parseInt(t.height*o,10),n.left=parseInt(t.width*c,10),n},_doRotation:function(i){var t,a,s=i*Math.PI/180,n=Math.cos(s),o=Math.sin(s);0>o&&(o=-o),0>n&&(n=-n),t=this._image.height*o+this._image.width*n,a=this._image.height*n+this._image.width*o;var c=e.createElement("canvas"),r=c.getContext("2d");c.width=parseInt(t,10),c.height=parseInt(a,10);var d=c.width/2,p=c.height/2;r.clearRect(0,0,c.width,c.height),r.translate(d,p),r.rotate(s),r.drawImage(this._image,-this._image.width/2,-this._image.height/2),this._image.src=c.toDataURL("image/png"),this._paintCanvas(),this._updateInput()},_resizeViewport:function(){var t=this._image,e={width:t.width,height:t.height};if("auto"!=this.options.maxWidth&&t.width>this.options.maxWidth&&(e.width=this.options.maxWidth),"auto"!=this.options.maxHeight&&t.height>this.options.maxHeight&&(e.height=this.options.maxHeight),this.options.aspectRatio){var a=t.width,s=t.height,n=a/s;a>e.width&&(e.width=parseInt(e.width,10),e.height=parseInt(e.width/n,10)),s>e.height&&(n=a/s,e.height=parseInt(e.height,10),e.width=parseInt(e.height*n,10))}i(this.element).css({width:e.width,height:e.height}),this._viewport=e,this._setVariable("resize_width",t.width),this._setVariable("resize_height",t.height)},_bindControlButtons:function(){var t=this;i(this.element).find(".picedit_control").bind("click",function(){var e=i(this).data("action");e?t[e](this):i(this).hasClass("picedit_action")&&(i(this).parent(".picedit_element").toggleClass("active").siblings(".picedit_element").removeClass("active"),i(this).parent(".picedit_element").hasClass("active")?i(this).closest(".picedit_nav_box").addClass("active"):i(this).closest(".picedit_nav_box").removeClass("active"))})},_bindInputVariables:function(){var t=this;i(this.element).find(".picedit_input").bind("change keypress paste input",function(){var e=i(this).data("variable");if(e){var a=i(this).val();t._variables[e]=a}if(("resize_width"==e||"resize_height"==e)&&t._variables.resize_proportions){var s=t._image.width/t._image.height;"resize_width"==e?t._setVariable("resize_height",parseInt(a/s,10)):t._setVariable("resize_width",parseInt(a*s,10))}})},_setVariable:function(t,e){this._variables[t]=e,i(this.element).find('[data-variable="'+t+'"]').val(e)},_updateInput:function(){if(!this._theformdata)return this.set_messagebox("Sorry, the FormData API is not supported!");var t=i(this.inputelement).prop("name");this._theformdata.append(t,this._image)},_template:function(){var t='<div class="picedit_box"><div class="picedit_message"><span class="picedit_control ico-picedit-close" data-action="hide_messagebox"></span><div></div></div><div class="picedit_nav_box picedit_gray_gradient"><div class="picedit_pos_elements"></div><div class="picedit_nav_elements"><div class="picedit_element"><span class="picedit_control picedit_action ico-picedit-pencil" title="Pen Tool"></span><div class="picedit_control_menu"><div class="picedit_control_menu_container picedit_tooltip picedit_elm_3"><label class="picedit_colors"><span title="Black" class="picedit_control picedit_action picedit_black active" data-action="toggle_button" data-variable="pen_color" data-value="black"></span><span title="Red" class="picedit_control picedit_action picedit_red" data-action="toggle_button" data-variable="pen_color" data-value="red"></span><span title="Green" class="picedit_control picedit_action picedit_green" data-action="toggle_button" data-variable="pen_color" data-value="green"></span></label><label><span class="picedit_separator"></span></label><label class="picedit_sizes"><span title="Large" class="picedit_control picedit_action picedit_large" data-action="toggle_button" data-variable="pen_size" data-value="16"></span><span title="Medium" class="picedit_control picedit_action picedit_medium" data-action="toggle_button" data-variable="pen_size" data-value="8"></span><span title="Small" class="picedit_control picedit_action picedit_small" data-action="toggle_button" data-variable="pen_size" data-value="3"></span></label></div></div></div><div class="picedit_element"><span class="picedit_control picedit_action ico-picedit-insertpicture" title="Crop" data-action="crop_open"></span></div><div class="picedit_element"><span class="picedit_control picedit_action ico-picedit-redo" title="Rotate"></span><div class="picedit_control_menu"><div class="picedit_control_menu_container picedit_tooltip picedit_elm_1"><label><span>90° CW</span><span class="picedit_control picedit_action ico-picedit-redo" data-action="rotate_cw"></span></label><label><span>90° CCW</span><span class="picedit_control picedit_action ico-picedit-undo" data-action="rotate_ccw"></span></label></div></div></div><div class="picedit_element"><span class="picedit_control picedit_action ico-picedit-arrow-maximise" title="Resize"></span><div class="picedit_control_menu"><div class="picedit_control_menu_container picedit_tooltip picedit_elm_2"><label><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="resize_image"></span><span class="picedit_control picedit_action ico-picedit-close" data-action=""></span></label><label><span>Width (px)</span><input type="text" class="picedit_input" data-variable="resize_width" value="0"></label><label class="picedit_nomargin"><span class="picedit_control ico-picedit-link" data-action="toggle_button" data-variable="resize_proportions"></span></label><label><span>Height (px)</span><input type="text" class="picedit_input" data-variable="resize_height" value="0"></label></div></div></div></div></div><div class="picedit_canvas_box"><div class="picedit_action_btns"><div class="picedit_control ico-picedit-picture" data-action="load_image"></div><div class="picedit_control ico-picedit-camera" data-action="camera_open"></div><div class="center">or copy/paste image here</div></div><div class="picedit_canvas"><canvas></canvas></div><div class="picedit_painter"></div></div><div class="picedit_video"><video autoplay></video><div class="picedit_video_controls"><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="take_photo"></span><span class="picedit_control picedit_action ico-picedit-close" data-action="camera_close"></span></div></div><div class="picedit_drag_resize"><div class="picedit_drag_resize_canvas"></div><div class="picedit_drag_resize_box"><div class="picedit_drag_resize_box_corner_wrap"><div class="picedit_drag_resize_box_corner"></div></div><div class="picedit_drag_resize_box_elements"><span class="picedit_control picedit_action ico-picedit-checkmark" data-action="crop_image"></span><span class="picedit_control picedit_action ico-picedit-close" data-action="crop_close"></span></div></div></div></div>',e=this;i(this.inputelement).hide().after(t).each(function(){e.element=i(e.inputelement).next(".picedit_box"),e.init()})}},i.fn[n]=function(t){var e=arguments;if(t===a||"object"==typeof t)return this.each(function(){i.data(this,"plugin_"+n)||i.data(this,"plugin_"+n,new s(this,t))});if("string"==typeof t&&"_"!==t[0]&&"init"!==t){var o;return this.each(function(){var a=i.data(this,"plugin_"+n);a instanceof s&&"function"==typeof a[t]&&(o=a[t].apply(a,Array.prototype.slice.call(e,1))),"destroy"===t&&i.data(this,"plugin_"+n,null)}),o!==a?o:this}}}(jQuery,window,document);